<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400..800&display=swap" rel="stylesheet">
    <link rel="icon" href="https://assets.hackclub.com/flag-standalone.svg" type="image/png">
    <title>Calendar | High Seas</title>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js";
        import { serverTimestamp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-firestore.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, getDocs, onSnapshot, query, orderBy } 
          from "https://www.gstatic.com/firebasejs/11.2.0/firebase-firestore.js";
      
          const firebaseConfig = {
            apiKey: "AIzaSyBRocuCXr6zBpauLs6nSLEo_CBe29_vp1E",
            authDomain: "calendar-eec37.firebaseapp.com",
            projectId: "calendar-eec37",
            storageBucket: "calendar-eec37.firebasestorage.app",
            messagingSenderId: "338748857741",
            appId: "1:338748857741:web:24d41a9a20be4d1e7b31c4",
            measurementId: "G-8T1BJK1F25"
        };
      
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
    
        // Export Firebase functions
        window.initializeFirebase = async () => {
            return {
                saveEvent: async (event) => {
                    await setDoc(doc(db, "events", event.id.toString()), event);
                },
                deleteEvent: async (eventId) => {
                    await deleteDoc(doc(db, "events", eventId));
                },
                loadEvents: async () => {
                    const querySnapshot = await getDocs(collection(db, "events"));
                    return querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                },
                setupRealTimeUpdates: (updateCallback) => {
                    return onSnapshot(collection(db, "events"), (snapshot) => {
                        const events = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        updateCallback(events);
                    });
                },
                getUsers: async () => {
                    const querySnapshot = await getDocs(collection(db, "users"));
                    return querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); // Include document ID
                },
                logAction: async (actionData) => {
                    await setDoc(doc(db, "actionLogs", Date.now().toString()), {
                        ...actionData,
                        timestamp: serverTimestamp()
                    });
                },
                getActionLogs: async () => {
                    const querySnapshot = await getDocs(
                        query(collection(db, "actionLogs"), orderBy("timestamp", "desc"))
                    );
                    return querySnapshot.docs.map(doc => doc.data());
                }
            };
        };
    </script>

    <style>
        :root {
            --seaquest-blue: #0C1230;
            --seaquest-red: #7F0003;
            --accent-blue: #2c3e50;

            --bg-color: #f0f8ff;
            --text-color: var(--seaquest-blue);
            --header-bg: white;
            --day-bg: white;
            --event-bg: #e3f2fd;
            --modal-bg: white;
        }

        .dark-mode {
            --bg-color: #0C1230;
            --text-color: #ffffff;
            --header-bg: #1a1a2e;
            --day-bg: #2c3e50;
            --event-bg: #3a506b;
            --modal-bg: #2c3e50;
            --seaquest-red: #ff4d4d;
        }

        #darkModeToggle {
            background-color: var(--seaquest-blue);
            color: white;
            border: none;
            margin-left: 10px;
        }

        body {
            font-family: "Syne", sans-serif;
            margin: 5px;
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 1rem;
            background-color: var(--bg-color);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .brand-logo {
            height: 64px;
            vertical-align: middle;
        }

        .calendar-controls {
            text-align: center;
            margin: 20px 0;
        }

        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            max-width: 1200px;
            margin: 20px auto;
        }

        .current-month {
            font-weight: bold;
            text-transform: uppercase;
            margin: 0 4px;
        }

        button {
            background-color: white;
            color: black;
            border: 2px solid var(--seaquest-red);
            padding: 6px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-family: "Syne", sans-serif;
            transition: all 0.2s ease;
            margin: 0 4px;
        }

        button:hover {
            background-color: var(--seaquest-red);
            color: white;
            transform: scale(1.05);
            font-weight: 500;
        }

        select {
            padding: 5px 12px;
            border-radius: 8px;
            border: 2px solid var(--seaquest-blue);
            font-family: "Syne", sans-serif;
            background-color: white;
            cursor: pointer;
        }

        .day {
            border: 1px solid #ccc;
            min-height: 120px;
            padding: 5px;
            background-color: var(--day-bg);
            position: relative;
            border-radius: 8px;
        }

        .day:hover {
            background-color: #f0f8ff;
            transition: all 0.2s ease;
            border: 0.5px solid var(--seaquest-blue);
        }

        .date-header {
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--seaquest-blue);
        }

        .event {
            background-color: var(--event-bg);
            padding: 8px;
            margin: 2px;
            border-radius: 6px;
            cursor: pointer;
            border: 1px solid #90caf9;
            font-size: 0.9em;
        }

        .event:hover {
            background-color: #f2f9ffb3;
            transition: 0.4s;
        }

        .understaffed {
            background-color: #ffe6e6 !important;
            border-color: var(--seaquest-red) !important;
        }

        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.95);
            background: var(--modal-bg);
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease-out;
            min-width: 300px;
        }
        
        .modal.active {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -50%) scale(1);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.1s ease-out;
        }
        
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
            transition: opacity 0.1s ease-out;
        }

        .alert-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.95);
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1001;
            opacity: 0;
            visibility: hidden;
            transition: all 0.1s ease-out;
        }
        
        .alert-modal.active {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -50%) scale(1);
        }

        /* Add to alert modal styles */
        .alert-modal .modal-button-group {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .alert-modal button {
            min-width: 80px;
            margin: 0;
        }

        #confirmCancel {
            background-color: #f0f0f0;
            color: var(--seaquest-blue);
            border: 2px solid #ccc;
        }

        #confirmCancel:hover {
            background-color: #e0e0e0;
        }

        .alert-content {
            text-align: center;
        }
        .alert-content button {
            margin-top: 15px;
            padding: 8px 24px;
        }

        .assigned-instructors {
            margin: 10px 0;
            color: var(--seaquest-blue);
            font-weight: 500;
        }

        .history-entry {
            padding: 8px;
            margin: 5px 0;
            background-color: #f8f9fa;
            border-radius: 6px;
            font-size: 0.9em;
        }

        #historyModal {
            color: var(--text-color);
            background-color: var(--modal-bg);
        }

        #historyContent {
            max-height: 60vh;
            overflow-y: auto;
            padding: 10px;
        }

        .instructor-list {
            margin: 10px 0;
        }

        .user-login {
            margin-left: 20px;
            background-color: var(--seaquest-blue);
            color: white;
            border-radius: 8px;
            cursor: pointer;
        }

        .today {
            background-color: #fff3e0;
            border: 2px solid var(--seaquest-red);
        }
        
        .admin-controls {
            margin: 20px 0;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 12px;
            border: 2px solid var(--seaquest-blue);
            display: none;
            overflow: hidden;
        }

        .admin-toggle {
            padding: 12px;
            background-color: var(--seaquest-blue);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: "Syne", sans-serif;
            font-size: 1em;
            text-align: left;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .admin-toggle:hover {
            background-color: #0a0f24;
        }

        .admin-form-content {
            max-height: 0;
            opacity: 0;
            transition: all 0.3s ease-out;
            padding: 0 20px;
        }

        .admin-controls.expanded .admin-form-content {
            max-height: 500px;
            opacity: 1;
            padding: 20px;
        }

        .admin-controls.expanded .admin-toggle::after {
            content: "▲";
        }

        .admin-toggle::after {
            content: "▼";
            font-size: 0.8em;
            margin-left: auto;
            padding-left: 10px;
        }
        
        .event-form input, 
        .event-form select {
            margin: 5px;
            padding: 8px;
            border: 2px solid var(--seaquest-blue);
            border-radius: 8px;
            font-family: Syne;
        }

        .day.prev-month {
            background-color: #f8f9fa;
            color: #666;
        }
        .day.prev-month .date-header {
            font-weight: normal;
        }
        .weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            max-width: 1200px;
            margin: 0 auto 10px auto;
            font-weight: bold;
            color: var(--seaquest-blue);
        }
        .instructor-chip {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            margin: 2px;
            font-size: 0.8em;
            background-color: #e3f2fd;
            cursor: pointer;
        }
        .remove-chip {
            display: none;
            cursor: pointer;
            margin-left: 4px;
            color: var(--seaquest-red);
        }
        .instructor-chip:hover .remove-chip {
            display: inline-block;
        }

        /* Add color variations */
        .instructor-chip[data-instructor="gan"] { background-color: #FFE0B2; }
        .instructor-chip[data-instructor="colby"] { background-color: #C8E6C9; }
        .instructor-chip[data-instructor="wayne"] { background-color: #BBDEFB; }
        .instructor-chip[data-instructor="am"] { background-color: #FFCDD2; }
        .instructor-chip[data-instructor="hakim"] { background-color: #e3cdff; }
        
        /* Add to style section */
        .modal-button-group {
            display: flex;
            gap: 8px;
            margin-top: 15px;
        }

        .remove-chip {
            display: inline-block !important;
            color: #666;
            transition: color 0.2s ease;
        }

        .instructor-chip:hover .remove-chip {
            color: var(--seaquest-red);
        }

        .event .instructor-chip .remove-chip {
            display: none !important;
        }

        /* Modal chips - show remove button on hover */
        .modal .instructor-chip:hover .remove-chip {
            display: inline-block !important;
        }



        /* Mobile-first adjustments */
        @media (max-width: 768px) {
            .header {
                flex-wrap: wrap;
                gap: 0.5rem;
                padding: 0.75rem;
            }

            #darkModeToggle {
                order: 4; /* Position below other elements */
                width: 100%;
                margin: 5px 0;
            }
        
            /*.logo-container h7 {
                display: none; /* Hide version on mobile */
            /*}*/
            
        
            .brand-logo {
                height: 48px; /* Smaller logo */
            }
        
            .user-login {
                /*width: 45%;*/
                margin-left: 0;
                order: 3; /* Move to bottom of header */
            }
        
            .calendar-controls {
                flex-wrap: wrap;
                gap: 0.5rem;
            }
        
            .calendar-controls button {
                padding: 6px 12px;
                font-size: 0.9em;
                flex: 1 1 30%;
            }
        
            #currentMonth {
                order: -1;
                width: 100%;
                font-size: 1.2em;
            }
        
            .calendar {
                grid-template-columns: repeat(7, 1fr);
                gap: 2px;
                margin: 10px auto;
            }
        
            .day {
                min-height: 20px;
                padding: 3px;
                font-size: 0.8em;
            }
        
            .date-header {
                font-size: 0.9em;
            }
        
            .event {
                padding: 4px;
                margin: 1px;
                font-size: 0.7em;
            }
        
            .weekdays {
                font-size: 0.8em;
                margin-bottom: 5px;
            }
        
            .modal {
                width: 90% !important;
                padding: 16px;
            }
        
            .admin-controls {
                padding: 8px;
            }
        
            .event-form {
                display: grid;
                grid-template-columns: 1fr;
                gap: 8px;
            }
        
            .event-form input, 
            .event-form select {
                width: 100%;
                margin: 2px 0;
            }
        
            button {
                min-width: 60px;
                padding: 8px 12px;
            }

            .admin-toggle {
                font-size: 0.8em;
                width: 50%;
                padding: 8px
            }
        }
        
        @media (max-width: 480px) {
            .calendar-controls {
                margin: 8px 0;
            }
        
            .calendar-controls button {
                font-size: 0.8em;
                padding: 4px 8px;
            }
        
            .day {
                min-height: 20px;
                padding: 2px;
                font-size: 0.9em;
            }
        
            .event {
                padding: 1px;
                /*display: none; Hide event details on smallest screens*/
            }
        
            .event::after {
                /*content: "📅"; /* Show calendar emoji instead */
                display: block;
                text-align: center;
            }
        }
        
        /* Existing header adjustments */
        .logo-container {
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .header h1 {
            font-size: 1.5em;
            margin-right: auto;
        }
        
        /* Better touch targets */
        button, select, .instructor-chip {
            touch-action: manipulation;
        }
        
        /* Prevent text overflow */
        .date-header {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Ensure grid alignment */
        .weekdays, .calendar {
            grid-template-columns: repeat(7, minmax(0, 1fr));
        }
        
        .weekdays div {
            text-align: center;
            padding: 5px 0;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo-container">
            <a href="https://seaquest-academy.com"><img src="https://assets.hackclub.com/flag-standalone.svg" 
                 alt="Hack Club Logo" 
                 class="brand-logo"></a>
            <h1>Calendar</h1>
            <h7>v1.4.16</h7>
        </div>
        <button class="user-login" onclick="showHistory()">History</button>
        <!--<button id="darkModeToggle" onclick="toggleDarkMode()">🌓 Dark Mode</button>-->
        <select id="userSelect" class="user-login">
            <option value="">Select User</option>"
        </select>
    </div>

    <div class="admin-controls" id="adminControls">
        <button class="admin-toggle" onclick="toggleAdminForm()">Admin Event Creation</button>
        <div class="admin-form-content">
            <div class="event-form">
                <input type="date" id="eventDateInput" required>
                <input type="time" id="startTimeInput" required>
                <input type="time" id="endTimeInput" required>
                <select id="eventSchoolInput">
                    <option value="hackathon">Hackathon</option>
                    <option value="meeting">Hack Club Meeting</option>
                </select>
                <input type="number" id="eventStudentsInput" placeholder="Students" min="1" required>
                <button onclick="createNewEvent()">Create Event</button>
            </div>
        </div>
    </div>

    <div class="calendar-controls">
        <button onclick="jumpToToday()">Today</button>
        <button onclick="changeMonth(-1)">&lt; Previous</button>
        <span id="currentMonth" class="current-month"></span>
        <button onclick="changeMonth(1)">Next &gt;</button>
        <select id="yearSelect" onchange="updateYear(this.value)"></select>
    </div>

    <div class="calendar" id="calendar"></div>
    
    <div class="modal-overlay" id="modalOverlay"></div>
    <div class="modal" id="eventModal">
        <h3>Session Details</h3>
        <p id="eventDate"></p>
        <p>School: <span id="eventSchool"></span></p>
        <p>Time: <span id="eventTime"></span></p>
        <p>Duration: <span id="eventDuration"></span></p>
        <p>Students: <span id="eventStudents"></span></p>
        <div class="assigned-instructors">
            <strong>Leaders:</strong>
            <div id="instructorList"></div>
        </div>
        <div class="instructor-select-container">
            <button onclick="toggleInstructorSelect()">Add leaders</button>
            <select id="instructorSelect" style="display: none;" onchange="handleInstructorSelect(this)">
                <option value="">Select Users</option>
            </select>
        </div>
        <div class="modal-button-group">
            <button onclick="closeModal()">Close</button>
            <button id="deleteEventButton" onclick="deleteEvent()" 
                    style="background-color: var(--seaquest-red); color: white;">
                Delete Event
            </button>
        </div>
        <div id="loginPrompt" style="display: none; color: var(--seaquest-red); margin-top: 10px;">
            Sign in at the top-right to make changes.
        </div>
    </div>

    <div class="modal" id="createEventModal">
        <h3>Create New Event</h3>
        <div class="event-form">
            <input type="date" id="newEventDate" required>
            <input type="time" id="newStartTime" required>
            <input type="time" id="newEndTime" required>
            <select id="newEventSchool">
                <option value="hackathon">Hackathon</option>
                <option value="meeting">Hack Club Meeting</option>
            </select>
            <input type="number" id="newEventStudents" placeholder="Students" min="1" required>
            <button onclick="createNewEventFromModal()">Create</button>
            <button onclick="closeCreateModal()">Cancel</button>
        </div>
    </div>

    <div class="alert-modal">
        <div class="alert-content">
            <p id="alert-message"></p>
            <div class="modal-button-group">
                <button id="confirmOk">OK</button>
                <button id="confirmCancel">Cancel</button>
            </div>
        </div>
    </div>

    <div class="modal" id="historyModal">
        <h3>Action History</h3>
        <div id="historyContent" style="max-height: 60vh; overflow-y: auto; margin-top: 15px;"></div>
        <div class="modal-button-group" style="margin-top: 20px;">
            <button onclick="closeHistoryModal()">Close</button>
        </div>
    </div>

    <script>
        let currentUser = null; // Initialize currentUser
        const STUDENT_RATIO = 8; // Students per instructor
        let currentDate = new Date();
        const assignments = {};
        /*let events = [{
            id: 1,
            date: '2025-02-08',
            school: 'hackathon',
            startTime: '09:30',
            endTime: '11:30',
            students: 8,
            assignedInstructors: []
        }];*/
        let events = [];
        let unsubscribeFirestore = null;
        let selectedEventId = null;
        let firebase = null;

        const ADMIN_ROLE = 'admin';
        const INSTRUCTOR_ROLE = 'instructor';
        let users = [];
        let currentUserInfo = null;

        async function initializeControls() {
        // Initialize Firebase first
        try {
            firebase = await window.initializeFirebase();

            // Load users
            users = await firebase.getUsers();
            populateInstructorDropdown(users);
            
            // Populate user select
            const userSelect = document.getElementById('userSelect');
            userSelect.innerHTML = '<option value="">Select User</option>';
            users.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.text = user.name;
                // Add data attributes for role
                option.dataset.role = user.role; 
                userSelect.appendChild(option);
            });
            
            // Initialize year selector
            const yearSelect = document.getElementById('yearSelect');
            const currentYear = new Date().getFullYear();
            for (let year = currentYear - 2; year <= currentYear + 3; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.text = year;
                yearSelect.appendChild(option);
            }
            
            // Load initial events and setup real-time updates
            events = await firebase.loadEvents();
            updateCalendar();

            unsubscribeFirestore = firebase.setupRealTimeUpdates((firebaseEvents) => {
                events = firebaseEvents;
                updateCalendar();
            });

            // User login handling
            document.getElementById('userSelect').addEventListener('change', (e) => {
                const selectedOption = e.target.options[e.target.selectedIndex];
                currentUserInfo = {
                    id: e.target.value,
                    role: selectedOption.dataset.role
                };
                
                const isAdmin = currentUserInfo?.role === 'admin';
                document.getElementById('adminControls').style.display = isAdmin ? 'block' : 'none';
                updateCalendar();
            });
        } catch (error) {
            console.error("Failed to initialize Firebase:", error);
            alert("Failed to initialize calendar. Please try refreshing the page.");
        }
    }

    function toggleAdminForm() {
        const adminControls = document.getElementById('adminControls');
        adminControls.classList.toggle('expanded');
    }

    function showAlert(message) {
        document.getElementById('alert-message').textContent = message;
        document.querySelector('.alert-modal').classList.add('active');
        document.getElementById('modalOverlay').classList.add('active');
        
        // Hide cancel button for simple alerts
        document.getElementById('confirmCancel').style.display = 'none';
        document.getElementById('confirmOk').textContent = 'OK';

        return new Promise(resolve => {
            const handler = () => {
                closeAlert();
                resolve();
                document.getElementById('confirmOk').removeEventListener('click', handler);
            };
            document.getElementById('confirmOk').addEventListener('click', handler);
        });
    }

    function closeAlert() {
        document.querySelector('.alert-modal').classList.remove('active');
        document.getElementById('modalOverlay').classList.remove('active');
        // Reset alert buttons
        document.getElementById('confirmCancel').style.display = 'inline-block';
        document.getElementById('confirmOk').textContent = 'OK';
    }

    function populateInstructorDropdown(users) {
        const instructorSelect = document.getElementById('instructorSelect');
        instructorSelect.innerHTML = '<option value="">Select Leaders</option>';
        
        users.forEach(user => {
            const option = document.createElement('option');
            option.value = user.id;
            option.textContent = user.name;
            instructorSelect.appendChild(option);
        });
    }



        function generateCalendar() {
        const calendar = document.getElementById('calendar');
        calendar.innerHTML = '';
        
        // Remove existing weekday headers
        const existingWeekdays = document.querySelector('.weekdays');
        if (existingWeekdays) existingWeekdays.remove();
    
        // Add weekdays header
        const weekdays = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
        const weekdayContainer = document.createElement('div');
        weekdayContainer.className = 'weekdays';
        weekdays.forEach(day => {
            const dayElement = document.createElement('div');
            dayElement.textContent = day;
            weekdayContainer.appendChild(dayElement);
        });
        calendar.parentNode.insertBefore(weekdayContainer, calendar);
    
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const today = new Date();
        
        // Calculate previous month details
        const prevMonthYear = month === 0 ? year - 1 : year;
        const prevMonth = month === 0 ? 11 : month - 1;
        const prevMonthEnd = new Date(year, month, 0).getDate();
        
        // Get first day of current month (0 = Sunday)
        const firstDayOfMonth = new Date(year, month, 1).getDay();
        const emptyDays = (firstDayOfMonth + 6) % 7;
    
        // Add previous month's trailing days with events
        for (let i = emptyDays; i > 0; i--) {
            const prevDay = prevMonthEnd - i + 1;
            const dateStr = `${prevMonthYear}-${String(prevMonth + 1).padStart(2, '0')}-${String(prevDay).padStart(2, '0')}`;
            const dayElement = createDayElement(prevDay, dateStr);
            dayElement.classList.add('prev-month');
            
            // Add events for previous month dates
            events.filter(e => e.date === dateStr).forEach(event => {
                const eventElement = createEventElement(event);
                dayElement.appendChild(eventElement);
            });
            
            calendar.appendChild(dayElement);
        }
    
        // Create current month's days
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const dayElement = createDayElement(day, dateStr);
            
            // Highlight today
            if (day === today.getDate() && 
                month === today.getMonth() && 
                year === today.getFullYear()) {
                dayElement.classList.add('today');
            }
    
            // Add events
            events.filter(e => e.date === dateStr).forEach(event => {
                const eventElement = createEventElement(event);
                dayElement.appendChild(eventElement);
            });
            
            calendar.appendChild(dayElement);
        }
    
        // Update month display
        document.getElementById('currentMonth').textContent = 
            `${currentDate.toLocaleString('default', { month: 'long' })} ${year}`;
    }
    
    function createEventElement(event) {
        const required = Math.ceil(event.students / STUDENT_RATIO);
        const hasEnough = event.assignedInstructors.length >= required;
        
        const eventElement = document.createElement('div');
        eventElement.className = `event ${hasEnough ? '' : 'understaffed'}`;
        eventElement.innerHTML = `
            <div><strong>${formatTime(event.startTime)} - ${formatTime(event.endTime)}</strong></div>
            <div>${event.school}</div>
            <div>${event.students} participants</div>
            <div class="instructor-status">
                ${event.assignedInstructors.length}/${required} Leaders
                ${event.assignedInstructors.map(id => {
                    const user = users.find(u => u.id === id);
                    return `<span class="instructor-chip" data-instructor="${id}" onclick="removeInstructor('${id}')">
                        ${user ? user.name : 'Unknown'}
                        <span class="remove-chip">×</span>
                    </span>`;
                }).join('')}
            </div>
        `;
        eventElement.addEventListener('click', (e) => {
            e.stopPropagation();
            showEventModal(event.id);
        });
        return eventElement;
    }

    async function deleteEvent() {
        if (!currentUserInfo) return showAlert('Please sign in to make changes.');

        const event = events.find(e => e.id === selectedEventId);
        if (!event) return;
        
        const confirm = await showConfirm('Are you sure you want to delete this event?');
        if (!confirm) return;

        // Log BEFORE deletion
        await firebase.logAction({
            userId: currentUserInfo.id,
            userRole: currentUserInfo.role,
            actionType: 'delete_event',
            eventId: selectedEventId,
            eventDate: event.date
        });

        try {
            await firebase.deleteEvent(selectedEventId.toString());
            closeModal();
        } catch (error) {
            showAlert("Error deleting event: " + error.message);
        }
    }

    function createDayElement(day, dateStr) {
        const dayElement = document.createElement('div');
        dayElement.className = 'day';
        dayElement.innerHTML = `<div class="date-header">${day}</div>`;
        dayElement.dataset.date = dateStr;
        
        dayElement.addEventListener('click', function(e) {
            const isAdmin = currentUserInfo?.role === 'admin';
            if (isAdmin && !e.target.closest('.event')) {
                openCreateModal(dateStr);
            }
        });
        return dayElement;
    }

    function openCreateModal(dateStr) {
        if (currentUserInfo?.role !== ADMIN_ROLE) return;
        document.getElementById('newEventDate').value = dateStr;
        document.getElementById('modalOverlay').classList.add('active');
        document.getElementById('createEventModal').classList.add('active');
    }

    function closeCreateModal() {
        document.getElementById('modalOverlay').classList.remove('active');
        document.getElementById('createEventModal').classList.remove('active');
    }

    async function createNewEventFromModal() {

        if (!currentUserInfo) return showAlert('Please sign in to make changes.');

        const requiredFields = [
            document.getElementById('newEventDate'),
            document.getElementById('newStartTime'),
            document.getElementById('newEndTime'),
            document.getElementById('newEventStudents')
        ];
        
        if (requiredFields.some(field => !field.value)) {
            showAlert('Please fill all required fields');
            return;
        }
    
        const students = parseInt(document.getElementById('newEventStudents').value);
        if (isNaN(students) || students < 1) {
            showAlert('Please enter a valid number of students');
            return;
        }

        const startTime = document.getElementById('newStartTime').value;
        const endTime = document.getElementById('newEndTime').value;
        
        // Validate time format
        if (!/^\d{2}:\d{2}$/.test(startTime) || !/^\d{2}:\d{2}$/.test(endTime)) {
            showAlert("Please use HH:MM time format");
            return;
        }

        const newEvent = {
            id: Date.now(),
            date: document.getElementById('newEventDate').value,
            startTime: document.getElementById('newStartTime').value,
            endTime: document.getElementById('newEndTime').value,
            school: document.getElementById('newEventSchool').value,
            students: parseInt(document.getElementById('newEventStudents').value),
            assignedInstructors: []
        };

        // Calculate duration
        const [startHours, startMins] = newEvent.startTime.split(':').map(Number);
        const [endHours, endMins] = newEvent.endTime.split(':').map(Number);
        let minutes = (endHours * 60 + endMins) - (startHours * 60 + startMins);
        if(minutes < 0) minutes += 1440;
        newEvent.duration = `${Math.floor(minutes/60)}h ${minutes%60}m`;

        try {
            await firebase.saveEvent(newEvent);
            closeCreateModal();
        } catch (error) {
            showAlert("Error creating event: " + error.message);
        }

        //LOGGING
        await firebase.logAction({
            userId: currentUserInfo.id,
            userRole: currentUserInfo.role,
            actionType: 'create_event',
            eventId: newEvent.id,
            eventDate: newEvent.date
        });
    }

    function toggleInstructorSelect() {
        const select = document.getElementById('instructorSelect');
        select.style.display = select.style.display === 'none' ? 'inline' : 'none';
    }

    function handleInstructorSelect(selectElement) {
        const userId = selectElement.value;
        if (userId) {
            addInstructor(userId);
            selectElement.value = '';
            selectElement.style.display = 'none';
        }
    }

    async function addInstructor(userId) {
        if (!currentUserInfo) return showAlert('Please sign in to make changes.');
        
        const event = events.find(e => e.id === selectedEventId);
        if (!event) return;
        
        // Prevent duplicates
        if (!event.assignedInstructors.includes(userId)) {
            event.assignedInstructors.push(userId);
            firebase.saveEvent(event)
                .then(() => showEventModal(selectedEventId))
                .catch(console.error);
        }

        //Logging
        await firebase.logAction({
            userId: currentUserInfo.id,
            userRole: currentUserInfo.role,
            actionType: 'add_instructor',
            instructorId: userId,
            eventId: event.id,
            eventDate: event.date
        });
    }

    async function removeInstructor(userId) {
        if (!currentUserInfo) return showAlert('Please sign in to make changes.');
        
        const user = users.find(u => u.id === userId);
        const confirm = await showConfirm(`Remove ${user ? user.name : 'Unknown'} from event?`);
        if (!confirm) return;
        
        const event = events.find(e => e.id === selectedEventId);
        event.assignedInstructors = event.assignedInstructors.filter(id => id !== userId);
        firebase.saveEvent(event)
            .then(() => showEventModal(selectedEventId))
            .catch(console.error);

        //LOGGING
        await firebase.logAction({
            userId: currentUserInfo.id,
            userRole: currentUserInfo.role,
            actionType: 'remove_instructor',
            instructorId: userId,
            eventId: selectedEventId,
            eventDate: event.date
        });
    }

    async function showHistory() {
        const logs = await firebase.getActionLogs();
        const historyContent = document.getElementById('historyContent');
        historyContent.innerHTML = logs.map(log => formatLogEntry(log)).join('');
        
        document.getElementById('modalOverlay').classList.add('active');
        document.getElementById('historyModal').classList.add('active');
    }

    function closeHistoryModal() {
        document.getElementById('modalOverlay').classList.remove('active');
        document.getElementById('historyModal').classList.remove('active');
    }

    function formatLogEntry(log) {
        const date = log.timestamp?.toDate ? log.timestamp.toDate() : new Date();
        const timeString = date.toLocaleString('en-US', {
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });

        const user = users.find(u => u.id === log.userId) || { name: 'Unknown', role: 'unknown' };
        const instructor = log.instructorId ? users.find(u => u.id === log.instructorId) : null;
        let eventDate = log.eventDate ? new Date(log.eventDate).toDateString() : 'Unknown date';

        let actionText = '';
        let actionColor = 'black'; // Default color

        switch (log.actionType) {
            case 'add_instructor':
                actionText = `assigned ${instructor?.name || 'Unknown'} to`;
                actionColor = '#007b06'; // Green
                break;
            case 'remove_instructor':
                actionText = `removed ${instructor?.name || 'Unknown'} from`;
                actionColor = 'var(--seaquest-red)'; // Red
                break;
            case 'create_event':
                actionText = 'created';
                actionColor = '#007b06'; // Green
                break;
            case 'delete_event':
                actionText = 'deleted';
                actionColor = 'var(--seaquest-red)'; // Red
                eventDate = log.eventDate ? new Date(log.eventDate).toDateString() : 'Unknown date';
                break;
        }

        return `
            <div class="history-entry">
                ${timeString} | 
                ${user.name}
                <span style="color: ${actionColor};">${actionText}</span> 
                the <strong>${eventDate}</strong> event.
            </div>
        `;
    }


        function formatTime(timeString) {
            // Handle missing/invalid time
            if (!timeString || !timeString.includes(":")) return "Invalid Time";
            
            // Split and pad minutes
            const [hours, mins] = timeString.split(':');
            const paddedMins = (mins || "00").padStart(2, '0'); // Handle missing minutes
            
            // Format hours
            const hour = parseInt(hours) % 12 || 12;
            const ampm = parseInt(hours) >= 12 ? 'PM' : 'AM';
            
            return `${hour}:${paddedMins} ${ampm}`;
        }

        function jumpToToday() {
            currentDate = new Date();
            updateCalendar();
        }

        function updateYear(selectedYear) {
            currentDate.setFullYear(selectedYear);
            updateCalendar();
        }

        // Modified assignment logic
        function assignCurrentUser() {
            const event = events.find(e => e.id === selectedEventId);
            if (!event) return;
            
            if (event.assignedInstructors.includes(currentUser)) {
                event.assignedInstructors = event.assignedInstructors.filter(u => u !== currentUser);
            } else {
                event.assignedInstructors.push(currentUser);
            }
            updateCalendar();
            updateModalContent(event);
        }

        // Admin event creation logic
        async function createNewEvent() {
            const requiredFields = [
                document.getElementById('eventDateInput'),
                document.getElementById('startTimeInput'),
                document.getElementById('endTimeInput'),
                document.getElementById('eventStudentsInput')
            ];

            if (requiredFields.some(field => !field.value)) {
                showAlert('Please fill all required fields');
                return;
            }
        
            const students = parseInt(document.getElementById('eventStudentsInput').value);
            if (isNaN(students) || students < 1) {
                showAlert('Please enter a valid number of students');
                return;
            }
        
            const start = document.getElementById('startTimeInput').value;
            const end = document.getElementById('endTimeInput').value;
            if (!/^\d{2}:\d{2}$/.test(start) || !/^\d{2}:\d{2}$/.test(end)) {
                showAlert("Please use HH:MM time format");
                return;
            }
                
            const newEvent = {
                id: Date.now(),
                date: document.getElementById('eventDateInput').value,
                startTime: start,
                endTime: end,
                school: document.getElementById('eventSchoolInput').value,
                students: parseInt(document.getElementById('eventStudentsInput').value),
                assignedInstructors: []
            };
            
            // Calculate duration
            const [startHours, startMins] = start.split(':').map(Number);
            const [endHours, endMins] = end.split(':').map(Number);
            let minutes = (endHours * 60 + endMins) - (startHours * 60 + startMins);
            if(minutes < 0) minutes += 1440;
            newEvent.duration = `${Math.floor(minutes/60)}h ${minutes%60}m`;
            
            try {
                await firebase.saveEvent(newEvent);
                clearEventForm();
            } catch (error) {
                console.error("Error saving event:", error);
                showAlert("Error creating event: " + error.message);
            }
        }

        function clearEventForm() {
            document.getElementById('eventDateInput').value = '';
            document.getElementById('startTimeInput').value = '';
            document.getElementById('endTimeInput').value = '';
            document.getElementById('eventSchoolInput').value = 'hackathon';
            document.getElementById('eventStudentsInput').value = '';
        }

        function showEventModal(eventId) {            
            const event = events.find(e => e.id === eventId);
            if (!event) return;
            
            selectedEventId = eventId;
            document.getElementById('eventDate').textContent = new Date(event.date).toDateString();
            document.getElementById('eventSchool').textContent = event.school;
            document.getElementById('eventTime').textContent = 
                `${formatTime(event.startTime)} - ${formatTime(event.endTime)}`;
            document.getElementById('eventDuration').textContent = event.duration;
            document.getElementById('eventStudents').textContent = event.students;
            document.getElementById('instructorList').innerHTML = 
            document.getElementById('instructorList').innerHTML = 
            event.assignedInstructors.map(id => {
                const user = users.find(u => u.id === id);
                return `<span class="instructor-chip" data-instructor="${id}" onclick="removeInstructor('${id}')">
                    ${user ? user.name : 'Unknown'}
                    <span class="remove-chip">×</span>
                </span>`;
            }).join('') || 'No attendees assigned';

            document.getElementById('modalOverlay').classList.add('active');
            document.getElementById('eventModal').classList.add('active');
            
            const isLoggedIn = currentUserInfo !== null;
            const isAdmin = currentUserInfo?.role === ADMIN_ROLE;
            const deleteButton = document.getElementById('deleteEventButton');
            if (deleteButton) {
                const isAdmin = currentUserInfo?.role === ADMIN_ROLE;
                deleteButton.style.display = (currentUserInfo && isAdmin) ? 'inline-block' : 'none';
            }
            
            // Show/hide login prompt and buttons
            document.getElementById('loginPrompt').style.display = isLoggedIn ? 'none' : 'block';
            document.getElementById('addInstructorButton').style.display = isLoggedIn ? 'inline-block' : 'none';
            document.getElementById('deleteEventButton').style.display = (isLoggedIn && isAdmin) ? 'inline-block' : 'none';
            
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('active');
            document.getElementById('eventModal').classList.remove('active');
            document.querySelector('.alert-modal').classList.remove('active');
        }

        function showConfirm(message) {
            return new Promise((resolve) => {
                const alertModal = document.querySelector('.alert-modal');
                document.getElementById('alert-message').textContent = message;
                alertModal.classList.add('active');
                document.getElementById('modalOverlay').classList.add('active');

                const handleResponse = (result) => {
                    alertModal.classList.remove('active');
                    document.getElementById('modalOverlay').classList.remove('active');
                    resolve(result);
                    // Remove event listeners after resolution
                    document.getElementById('confirmOk').removeEventListener('click', okHandler);
                    document.getElementById('confirmCancel').removeEventListener('click', cancelHandler);
                };

                const okHandler = () => handleResponse(true);
                const cancelHandler = () => handleResponse(false);

                document.getElementById('confirmOk').addEventListener('click', okHandler);
                document.getElementById('confirmCancel').addEventListener('click', cancelHandler);
            });
        }

        async function assignCurrentUser() {
            if (!currentUser) {
                showAlert('Please select your user from the dropdown first!');
                return;
            }
            
            const event = events.find(e => e.id === selectedEventId);
            if (!event) return;
            
            // Create a copy to avoid mutation issues
            const updatedEvent = { ...event };
            const index = updatedEvent.assignedInstructors.indexOf(currentUser);
            
            if (index > -1) {
                updatedEvent.assignedInstructors.splice(index, 1);
            } else {
                updatedEvent.assignedInstructors.push(currentUser);
            }
            
            try {
                await firebase.saveEvent(updatedEvent);
                events = events.map(e => e.id === updatedEvent.id ? updatedEvent : e);
                showEventModal(selectedEventId);
            } catch (error) {
                console.error("Error updating assignment:", error);
                showAlert("Error saving assignment: " + error.message);
            }
        }

        // Add beforeunload handler
        window.addEventListener('DOMContentLoaded', () => {
            initializeControls().catch(error => {
                console.error('Failed to initialize:', error);
            });

            document.getElementById('modalOverlay').addEventListener('click', () => {
                closeModal();
                closeCreateModal();
                closeHistoryModal();
            });

            // Prevent modal content from closing when clicking inside
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => e.stopPropagation());
            });

            console.log(`Created by
░█▀▄░█▀█░█▀▀░█▀▀░█▀▀░▀█▀
░█▀▄░█░█░█░█░█░█░█▀▀░░█░
░▀▀░░▀▀▀░▀▀▀░▀▀▀░▀▀▀░░▀░ https://ganlouis.com
            `)
        });

        function pad(n) { return n < 10 ? '0' + n : n; }

        function changeMonth(offset) {
            // Save current date and reset to 1st to prevent month skip
            const originalDate = currentDate.getDate();
            currentDate.setDate(1);
            currentDate.setMonth(currentDate.getMonth() + offset);
            
            // Restore original date if valid for new month
            const daysInMonth = new Date(
                currentDate.getFullYear(),
                currentDate.getMonth() + 1,
                0
            ).getDate();
            currentDate.setDate(Math.min(originalDate, daysInMonth));
            
            updateCalendar();
        }

        function updateCalendar() {
            generateCalendar();
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDarkMode = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDarkMode);
            // Update button text
            const toggleBtn = document.getElementById('darkModeToggle');
            toggleBtn.textContent = isDarkMode ? '🌞 Light Mode' : '🌓 Dark Mode';
        }

        // Initialize dark mode from localStorage
        document.addEventListener('DOMContentLoaded', () => {
            const isDarkMode = localStorage.getItem('darkMode') === 'true';
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
                document.getElementById('darkModeToggle').textContent = '🌞 Light Mode';
            }
        });

        // User login handling
        document.getElementById('userSelect').addEventListener('change', (e) => {
            const selectedOption = e.target.options[e.target.selectedIndex];
            currentUserInfo = {
                id: e.target.value,
                role: selectedOption.dataset.role
            };
            
            const isAdmin = currentUserInfo?.role === 'admin';
            const adminControls = document.getElementById('adminControls');
            adminControls.style.display = isAdmin ? 'block' : 'none';
            // Collapse when switching users
            adminControls.classList.remove('expanded');
            updateCalendar();
        });
    </script>
</body>
</html>